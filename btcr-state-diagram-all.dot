// [rgrant 20170718 08:19 MST] graphviz exploration of DID:BTCR state diagram / simple and with recovery

// dot -Tpng btcr-state-diagram-all.dot > btcr-state-diagram-all.png && open btcr-state-diagram-all.png

digraph self_sovereign_btcr_state_diagram {
  pad="1,1" //i.e. margin

  init [
    label = "DID init \n (also using revocation proof)"
    shape = circle
    label = "state: init."
    layer = "all:simple:recovery"
  ]

  //subgraph cluster_usable {
    //label="Usable DID States"

    valid_simple [
      label = "state: valid Simple DID"
      shape=doublecircle
      color=green
      layer = "all:simple:recovery"
    ]

    valid_with_recovery_proof [
      label = "state: valid DID, \n (with recovery proof in tx~1)"
      shape=doublecircle
      color=green
      layer = "all:recovery"
    ]
  //}

  settling [
    xxlabel = "DDO control proof update, with default 24 hour settlement"
    shape=Mdiamond
    height=1.5
    width=2
    label = "state: settling..."
    layer = "all:recovery"
  ]

  frozen [
    shape=Mdiamond
    height=1.5
    width=2
    color=orange
    label = "state: frozen..."
    layer = "all:recovery"
  ]

  revoked [
    shape = doubleoctagon
    color=red
    label = "state: revoked!"
    layer = "all:simple:recovery"
  ]

  subgraph cluster_theft {
    label="Key Compromise / Theft"

    tx_theft_A0 [
      label = "TX: noncompliant BTC theft A0"
      shape=box
      color=red
      layer = "all:simple:recovery"
    ]

    tx_theft_B0 [
      label = "TX: noncompliant BTC theft B0"
      shape=box
      color=red
      layer = "all:recovery"
    ]

    tx_theft_A1 [
      label = "TX: compliant DID theft A1"
      shape=box
      color=red
      layer = "all:simple:recovery"
    ]

    tx_theft_B1 [
      label = "TX: compliant DID theft B1"
      shape=box
      color=red
      layer = "all:recovery"
    ]
  }
 
  tx_revocation [
    label = "TX: immediate revocation"
    shape=box
    color=orange
    layer = "all:simple:recovery"
  ]

  tx_recovery [
    label = "TX: recovery. \n (DID follows this UTXO!)"
    shape=box
    layer = "all:recovery"
  ]

  tx_simple_update [
    label = "TX: simplest compliant update"
    shape=box
    layer = "all:simple:recovery"
  ]

  tx_update_with_recovery_proof [
    label = "TX: compliant update \n (also including recovery proof)"
    shape=box
    layer = "all:recovery"
  ]

  init -> valid_simple

  valid_with_recovery_proof -> tx_update_with_recovery_proof [ layer = "all:simple:recovery" ]
  tx_update_with_recovery_proof -> settling [ layer = "all:simple:recovery" ]

  settling -> valid_with_recovery_proof [label="timeout", layer = "all:simple:recovery" ]
  settling -> tx_revocation [ layer = "all:simple:recovery" ]

  valid_simple -> tx_simple_update [ layer = "all:simple:recovery" ]
  tx_simple_update -> valid_simple [ layer = "all:simple:recovery" ]

  valid_simple -> tx_theft_A0 [color=red, layer = "all:simple:recovery" ]
  tx_theft_A0 -> revoked [color=red, layer = "all:simple:recovery" ]

  valid_with_recovery_proof -> tx_theft_B0 [color=red, layer = "all:simple:recovery" ]
  tx_theft_B0 -> frozen [color=red, layer = "all:simple:recovery" ]

  valid_simple -> tx_theft_A1 [color=red, layer = "all:simple:recovery" ]
  tx_theft_A1 -> valid_simple [label="(temporarily succeeds)    ", fontcolor=red, color=red, layer = "all:simple:recovery" ]

  valid_with_recovery_proof -> tx_theft_B1 [color=red, layer = "all:recovery" ]
  tx_theft_B1 -> settling [layer = "all:recovery" ]

  frozen -> tx_recovery [ layer = "all:simple:recovery" ]
  tx_recovery -> valid_with_recovery_proof  [fontcolor=darkgreen, layer = "all:simple:recovery" ]
  frozen -> revoked   [label="timeout", color=red, fontcolor=red, layer = "all:simple:recovery" ]

  valid_with_recovery_proof -> tx_revocation  [color=orange, layer = "all:simple:recovery" ]
  valid_simple -> tx_revocation  [color=orange, layer = "all:simple:recovery" ]

  tx_revocation -> revoked  [color=orange, layer = "all:simple:recovery" ]
}

